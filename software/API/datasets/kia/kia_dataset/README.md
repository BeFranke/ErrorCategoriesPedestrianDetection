# KIA Dataset

> This repository contains code that will download (incrementally) the KIA Dataset and make it conform to E1.2.3.

Contact Person: Michael.Fuerst@dfki.de

This repo provides the following functionalities:
1. Download and Extract the Dataset
2. Apply postprocessing scripts (e.g. name fixes).
3. A autogenerated documentation of the modules in [docs](docs/README.md).

**WARNING:** This script is use at own risk. Please inspect the script before running it carefully as it might destroy the data you downloaded! Repeat this with every update!

## Installation

Make sure you meet the requirements:
* Python 3.6+ (preferably in a virtual environment)
* Ubuntu 18.04 LTS, Ubuntu 20.04 LTS or Red Hat Enterprise Linux 7.3

### Installation of minio client

In order to work with the provided scripts, the minio client must be installed and the command `mc` must exist. In order to install the minio client you can use the following bash script:

```bash
wget https://dl.min.io/client/mc/release/linux-amd64/mc
chmod +x mc
echo "alias mc='${PWD}/mc'" >> ~/.bashrc
source ~/.bashrc
```

This script will install minio client into the current directory.

### Clone repository and install scripts

Clone this repo and install it.
```bash
git clone git@gitlab.com:kia2/code/shared-libraries/kia_dataset.git
cd kia_dataset
# TODO install all requirements from conda_requirements.txt
pip install -e .
cd ..
```

You can later update by going to kia_dataset and git pull.
```bash
cd kia_dataset
git pull
cd ..
```

### Minio client configuration

Please setup the minio client on your system and name the remote for the project "kia", by executing the following command:
```bash
mc alias set kia https://kip.gpu-cluster.itwm.fraunhofer.de <username> <password> --api s3v4
```
Note that `<username>` is equal to the access key and `<password>` is equal to the secret key.

## Usage

### Download and Extract

You can download and extract the data by running (`--cache_path` defines where the tars are stored and `--data_path` defines where to store the data itself, `--filename_download_journal` is a file where the command stores what tars were already downloaded and extracted and `--remote_name` is the name you gave the minio remote). For depth and exr data download use the flags `--download_exr` and `--download_depth`.
Please make sure, that the folders you are using exist, otherwise the script might fail!
```bash
kia_fetch --cache_path=$CACHE_DIR/KIA_Dataset_tars --filename_download_journal=$DATA_PATH/KIA_Dataset/downloaded.json --remote_name=kia [--download_exr] [--download_depth]
kia_extract --cache_path=$CACHE_DIR/KIA_Dataset_tars --data_path=$DATA_PATH/KIA_Dataset --delete_after_extract
```

The mentioned command to download the data (`kia_fetch`) is designed so that the downloaded files can be deleted after they have been extracted. If you do not have storage limitations you could instead use the `mc mirror` command, which will also look for updated data objects on the server and downloads them. After you have downloaded the files you can proceed with the `kia_extract` command, where `--cache_path` should direct to the downloaded data. Here is the complete command for mirroring the data via minio client:

```bash
mc mirror --exclude "*.md" --exclude "*.pdf" kia/release $CACHE_DIR/KIA_Dataset_tars
```

### Fix the Data

*Fix scripts are applied inplace. They are written in a way, that applying them twice does not break the data.*

This script fixes the remaining unextracted archive files and moves BIT TS tranche 1 sequence directories to the root path of the dataset.

```bash
kia_fix_extract --data_path=$DATA_PATH/KIA_Dataset [--dry_run] [--logfile ~/kia_fix_extract.log] [--no_delete]
```

This script fixes the names, so that they adhere to E1.2.3 naming schema.

```bash
kia_fix_names_tranche_1 --data_path=$DATA_PATH/KIA_Dataset
kia_fix_names_tranche_2 --data_path=$DATA_PATH/KIA_Dataset
```

There is also more advanced fixes for the content of files. Please read the [documentation](docs/README.md) for these fixes.
```bash
kia_fix_box_2d --data_path=$DATA_PATH/KIA_Dataset [--debug_mode true] [--estimate_depth false]
kia_fix_box_3d --data_path=$DATA_PATH/KIA_Dataset
```

### Test if the Data is OK

All test tools, are applied on a single sequence and a single company.
You can select the company by `--company=bit` or `--company=mv`.
For selecting the sequence, simply use `--sequence=93`

```bash
kia_test_filenames --data_path=$DATA_PATH/KIA_Dataset --sequence=93 --company=bit
kia_test_attributenames --data_path=$DATA_PATH/KIA_Dataset --sequence=93 --company=bit
```

### Visualize the Data for testing

You can visualize the dataset using the [visualize_dataset notebook](kia_dataset/tests/visualize_dataset.ipynb).

### Apply Post Processings

```bash
kia_pp_fake_lidar --data_path=$DATA_PATH/KIA_Dataset
```

## Folder Structure

All scripts assume the following folder structure. The structure under KIA_Dataset will be automatically created, if you use the fetch and extract scripts. If you do not use them, make sure you have the same structure, so that the scripts work.

```
$DATA_PATH
│
└───KIA_Dataset
    │   bit_sequence_0025-4beaace23b6d4d05a0373f2b0973f1f1.pdf
    │   ...
    │
    └───bit_results_sequence_0001-ca2bc3fda17b46faa33eb1dbf483d1b9
    |   |
    │   └───ground-truth
    |   |   |
    |   |   └───...
    |   |
    │   └───sensor
    |       |
    |       └───...
    |
    └───bit_results_sequence_0001-ca2bc3fda17b46faa33eb1dbf483d1b9
    |   |
    |   └───...
    |
    └───...
```

In case you want to do anything with the fetch script only, here is the folder structure that it creates.

```
$CACHE_DIR
│
└───KIA_Dataset_tars
    │   bit_results_sequence_0091-ed2d75b6bfb94b888e1ac2c10453286f.tar.gz
    │   ...
```

## Contribution Guidelines

I guess they should not surprise you.

### How to Contribute (if something is broken/missing)?

1. Check if an Issue already exists: https://gitlab.com/kia2/code/shared-libraries/kia_dataset/-/issues
2. Create an Issue to report what is broken.
3. Sometimes a "manual" fix is less effort than an automatic coded fix e.g. #3 and #4. In this case mention how to manually fix it in the issue, so others can find the issue and the "fix". Those issues should not be closed.

### How to Contribute Code?

1. Assign an Issue to yourself if you work on fixing it. This way we can ensure that there is no duplicate work done.
2. Create a new feature branch for the issue you are fixing.
3. At any stage during your development you can ask me (Michael Fürst) for a code review.
4. Make a merge request and assign it to me (Michael Fürst).
    1. I will review your code and maybe an iteration is required.
    2. Once we agree that the contribution is safe and does not break for others, I will accept the merge request.
